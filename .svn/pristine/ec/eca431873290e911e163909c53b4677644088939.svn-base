using GenerateTables.Models;
using ServerAPI.ViewModels;
using System;
using System.Collections.Generic;
using System.Linq;
using ServerAPI.Utilities;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;

namespace ServerAPI.Services
{
    public class ProgramRequestService : IProgramRequestService
    {
        private readonly AAtims _context;
        private readonly IPhotosService _photoService;
        private readonly IInmateService _inmateService;
        private readonly IAppointmentService _appointmentService;
        private readonly int _personnelId;
        private readonly IPersonService _personService;
        private readonly IFacilityHousingService _facilityHousingService;
        private string filtertype;
        private string gender;
        private int inmateClassificationId;
        private int personSexId;

        public ProgramRequestService(AAtims context, IHttpContextAccessor httpContextAccessor,
            IPersonService personService, IAppointmentService appointmentService,
            IInmateService inmateService,
            IFacilityHousingService facilityHousingService,
            IAtimsHubService atimsHubService, IPhotosService photosService)
        {
            _context = context;
            _personnelId = Convert.ToInt32(httpContextAccessor.HttpContext.User.FindFirst("personnelId")?.Value);
            _photoService = photosService;
            _appointmentService = appointmentService;
            _personService = personService;
            _inmateService = inmateService;
            _facilityHousingService = facilityHousingService;
        }

        // load the inmate & program request grid list
        public List<ProgramEligibility> GetProgramRequestEligibility(int facilityId, int inmateId, int programId)
        {
            List<ProgramEligibility> lstProgramreqEligibilities = new List<ProgramEligibility>();

            // This program table need to change based on programClass
            IQueryable<ProgramRequest> lstProgramReq = _context.ProgramRequest.Where(pro =>
                (inmateId == 0 || pro.InmateId == inmateId) && (programId == 0 || pro.ProgramClassId == programId)
                && pro.Inmate.InmateActive == 1 
                //&& (facilityId == 0 || pro.Program.ProgramCategory.FacilityId == facilityId
                //|| pro.Program.ProgramCategory.FacilityId == 0)
                );

            int[] lstDenyIds = lstProgramReq.Where(w => w.DeniedFlag == 1 && w.DeleteFlag == 0)
                .Select(s => s.ProgramRequestId).ToArray();

            List<int> lstProgramIds = lstProgramReq.Where(w => w.DeleteFlag == 0)
           .Select(s => s.ProgramClassId).ToList();

            List<QueueEligibilityPerson> getAppealReq = _context.ProgramRequestAppeal.
                Where(w => lstDenyIds.Contains(w.ProgramRequestId)
                && (!w.DeniedFlag.HasValue || w.DeniedFlag == 0))
                .Select(p => new QueueEligibilityPerson
                {
                    ProgramRequestId = p.ProgramRequestId,
                    PersonnelId = p.AppealBy,
                    Reason = p.AppealReason,
                    Note = p.AppealNote,
                    Date = p.AppealDate
                }).ToList();


            List<int> lstAppointmentProgramAssign = _context.AppointmentProgramAssign.Where(a => a.InmateId == inmateId)
                .Select(i => i.AppointmentProgramAssignId).ToList();

            lstProgramreqEligibilities = lstProgramReq.Select(p => new ProgramEligibility
            {
                RequestId = p.ProgramRequestId,
                ProgramId = p.ProgramClassId,
                InmateId = p.InmateId,
                PriorityLevel = p.PriorityLevel,
                Note = p.RequestNote,
                RequestDate = p.CreateDate,
                DeleteFlag = p.DeleteFlag == 1,
                ClassifyRouteFlag = p.ClassifyRouteFlag == 1,
                DeniedFlag = p.DeniedFlag == 1,
                //AppealFlag = p.AppealFlag == 1,

                // This program table need to change based on programClass
                //ProgramCategory = p.Program.ProgramCategory.ProgramCategory1,
                //ClassOrServiceName = p.Program.ClassOrServiceName,
                AssignedDetails = new QueueEligibilityPerson
                {
                    PersonnelId = p.AssignedBy,
                    Note = p.AssignedNote,
                    Date = p.AssignedDate
                },
                ClassifyRouteDetails = new QueueEligibilityPerson
                {
                    PersonnelId = p.ClassifyRouteBy,
                    Reason = p.ClassifyRouteReason,
                    Note = p.ClassifyRouteNote,
                    Date = p.ClassifyRouteDate
                },
                DeniedDetails = new QueueEligibilityPerson
                {
                    PersonnelId = p.DeniedBy,
                    Reason = p.DeniedReason,
                    Note = p.DeniedNote,
                    Date = p.DeniedDate
                },
                AppointmentProgramAssignId = p.AppointmentProgramAssignId ?? 0,
                UpdateDetails = new QueueEligibilityPerson
                {
                    UpdateDate = p.UpdateDate,
                    PersonnelId = p.UpdateBy
                },
                CreateDate = p.CreateDate,
                PhotoFilePath = _photoService.GetPhotoByIdentifier(p.Inmate.Person.Identifiers
                .LastOrDefault(s => s.IdentifierType == "1" && s.DeleteFlag == 0))
            }).ToList();
            //Person Details List
            List<PersonVm> lstPersonDetails =
                _inmateService.GetInmateDetails(lstProgramreqEligibilities.Select(i => i.InmateId).ToList());
            //List of Housing Details for inmates 
            List<HousingDetail> lstHousingDetail = _facilityHousingService.GetHousingList(lstPersonDetails
                .Where(i => i.HousingUnitId.HasValue).Select(i => i.HousingUnitId.Value).ToList());

            //List of Schedule Details for Program 

            //List of all Officer Ids
            List<int> personnelId = lstProgramreqEligibilities.Select(i => new[]
            {
                i.AssignedDetails.PersonnelId, i.ClassifyRouteDetails.PersonnelId,
                i.DeniedDetails.PersonnelId, i.UpdateDetails.PersonnelId
                //i.AppealDetails.PersonnelId
            }).SelectMany(i => i).Where(i => i.HasValue).Select(i => i.Value).ToList();
            //List of Officer Details
            List<PersonnelVm> lstPersonDet = _personService.GetPersonNameList(personnelId);

            IQueryable<AppointmentProgramAssign> lstApp = _context.AppointmentProgramAssign;
            List<ScheduleVm> schList = _context.ScheduleProgram.Where(a =>
              !a.DeleteFlag &&
              (programId == 0 || lstProgramIds.Contains(a.ProgramClassId ?? 0))).Select(sch => new ScheduleVm
              {
                  StartDate = sch.StartDate, //apptstartdate hrs
                    EndDate = sch.EndDate, //apptenddate hrs
                    LocationId = sch.LocationId ?? 0,
                  ScheduleId = sch.ScheduleId, // appointment id
                   // ProgramId = sch.ProgramId, // program id
                    //InmateId = sch.InmateId ?? 0,
                  //ReasonId = sch.ReasonId,
                  //TypeId = sch.TypeId,
                  Location = sch.Location.PrivilegeDescription,
                  Duration = sch.Duration,
                  DeleteReason = sch.DeleteReason,
                  //Notes = sch.Notes,
                  IsSingleOccurrence = sch.IsSingleOccurrence,
                  LocationDetail = sch.LocationDetail, // apptlocation
                    DayInterval = sch.DayInterval,
                  WeekInterval = sch.WeekInterval,
                  FrequencyType = sch.FrequencyType,
                  QuarterInterval = sch.QuarterInterval,
                  MonthOfQuarterInterval = sch.MonthOfQuarterInterval,
                  MonthOfYear = sch.MonthOfYear,
                  DayOfMonth = sch.DayOfMonth
              }).ToList();

            List<int> lstprogamids = schList.Select(s => s.ProgramId ?? 0).ToList();

            lstProgramreqEligibilities.ForEach(item =>
            {
                item.InmateDetails = lstPersonDetails.Single(inm => inm.InmateId == item.InmateId);
                item.AppealDetails = getAppealReq.LastOrDefault(w => w.ProgramRequestId == item.RequestId);
                item.ScheduleDetails = schList.Where(inm => lstprogamids.Contains(item.ProgramId)).ToList();
                if (item.InmateDetails.HousingUnitId.HasValue)
                {
                    item.HousingDetails =
                        lstHousingDetail.Single(inm => inm.HousingUnitId == item.InmateDetails.HousingUnitId.Value);
                }

                if (item.AssignedDetails.PersonnelId.HasValue)
                {
                    PersonnelVm personInfo =
                        lstPersonDet.Single(p => p.PersonnelId == item.AssignedDetails.PersonnelId);
                    item.AssignedDetails.PersonLastName = personInfo?.PersonLastName;
                    item.AssignedDetails.OfficerBadgeNumber = personInfo?.OfficerBadgeNumber;
                }

                if (item.ClassifyRouteDetails.PersonnelId.HasValue)
                {
                    PersonnelVm personInfo =
                        lstPersonDet.Single(p => p.PersonnelId == item.ClassifyRouteDetails.PersonnelId);
                    item.ClassifyRouteDetails.PersonLastName = personInfo?.PersonLastName;
                    item.ClassifyRouteDetails.OfficerBadgeNumber = personInfo?.OfficerBadgeNumber;
                }

                if (item.DeniedDetails.PersonnelId.HasValue)
                {
                    PersonnelVm personInfo =
                        lstPersonDet.Single(p => p.PersonnelId == item.DeniedDetails.PersonnelId);
                    item.DeniedDetails.PersonLastName = personInfo?.PersonLastName;
                    item.DeniedDetails.OfficerBadgeNumber = personInfo?.OfficerBadgeNumber;
                }
                if (item.UpdateDetails.PersonnelId.HasValue)
                {
                    PersonnelVm personInfo =
                        lstPersonDet.Single(p => p.PersonnelId == item.UpdateDetails.PersonnelId);
                    item.UpdateDetails.PersonLastName = personInfo?.PersonLastName;
                    item.UpdateDetails.OfficerBadgeNumber = personInfo?.OfficerBadgeNumber;
                }
                if (item.AppointmentProgramAssignId > 0)
                {
                    AppointmentProgramAssign appointmentinfo = lstApp?.SingleOrDefault
                        (x => x.AppointmentProgramAssignId == item.AppointmentProgramAssignId);
                        item.ProgramComplete = appointmentinfo?.ProgramComplete;
                        item.ProgramNotComplete = appointmentinfo?.ProgramNotComplete;
                        item.ProgramUnassignReason = appointmentinfo?.ProgramUnassignReason;
                }
            });

            return lstProgramreqEligibilities;
        }

        // load the inmate & program request mutiple drop down list
        public List<ProgramEligibility> GetProgramClassNameList(int facilityId, int inmateId)
        {
            if (inmateId > 0)
            {
                inmateClassificationId =
                   _context.Inmate.SingleOrDefault(w => w.InmateId == inmateId).InmateClassificationId ?? 0;
                personSexId = _context.Inmate.Where(w => w.InmateId == inmateId)
                   .Select(s => s.Person.PersonSexLast ?? 0).SingleOrDefault();
            }

            if (inmateClassificationId > 0)
            {
                //get classification
                filtertype = _context.InmateClassification
                    .SingleOrDefault(w => w.InmateId == inmateId && w.InmateClassificationId == inmateClassificationId)
                    .InmateClassificationReason;
            }

            if (personSexId > 0)
            {
                //get gender
                gender = _context.Lookup
                    .FirstOrDefault(w => w.LookupIndex == personSexId && w.LookupType == LookupConstants.SEX)
                    .LookupDescription;
            }

            List<ProgramEligibility> lsProgramEligibility = _context.Program
                .Where(p => (facilityId == 0 || p.ProgramCategory.FacilityId == facilityId) &&
                            (p.DeleteFlag == 0) && (p.ProgramCategory.DeleteFlag == 0) &&
                            (string.IsNullOrEmpty(filtertype) || p.ClassOrServiceClassFilter == filtertype ||
                             p.ClassOrServiceClassFilter == "" || p.ClassOrServiceClassFilter == null) &&
                            (string.IsNullOrEmpty(gender) || p.ClassOrServiceGenderFilter == gender ||
                             (p.ClassOrServiceGenderFilter == "" || p.ClassOrServiceGenderFilter == null)))
                .Select(r => new ProgramEligibility
                {
                    ProgramId = r.ProgramId,
                    ClassOrServiceNumber = r.ClassOrServiceNumber,
                    ClassOrServiceName = r.ClassOrServiceName,
                    ProgramCategory = r.ProgramCategory.ProgramCategory1,
                    IsChecked = false
                }).ToList();

            return lsProgramEligibility;
        }

        // load the inmate & program request drop down list
        public List<ProgramEligibility> GetProgramClassList(int facilityId, int inmateId)
        {

            if (inmateId > 0)
            {
                inmateClassificationId =
                    _context.Inmate.SingleOrDefault(w => w.InmateId == inmateId).InmateClassificationId ?? 0;
                personSexId = _context.Inmate.Where(w => w.InmateId == inmateId)
                    .Select(s => s.Person.PersonSexLast ?? 0).SingleOrDefault();
            }

            if (inmateClassificationId > 0)
            {
                //get classification
                filtertype = _context.InmateClassification
                    .SingleOrDefault(w => w.InmateId == inmateId && w.InmateClassificationId == inmateClassificationId)
                    .InmateClassificationReason;
            }

            if (personSexId > 0)
            {
                //get gender
                gender = _context.Lookup
                    .FirstOrDefault(w => w.LookupIndex == personSexId && w.LookupType == LookupConstants.SEX)
                    .LookupDescription;
            }

            List<ProgramEligibility> lsKeyValuePairs = _context.Program
                .Where(p => (facilityId == 0 || p.ProgramCategory.FacilityId == facilityId) &&
                            (p.DeleteFlag == 0) && (p.ProgramCategory.DeleteFlag == 0) &&
                            (string.IsNullOrEmpty(filtertype) || p.ClassOrServiceClassFilter == filtertype ||
                             p.ClassOrServiceClassFilter == "" || p.ClassOrServiceClassFilter == null) &&
                            (string.IsNullOrEmpty(gender) || p.ClassOrServiceGenderFilter == gender ||
                             (p.ClassOrServiceGenderFilter == "" || p.ClassOrServiceGenderFilter == null)))
                .Select(r => new ProgramEligibility
                {
                    ProgramId = r.ProgramId,
                    ClassOrServiceNumber = r.ClassOrServiceNumber,
                    ClassOrServiceName = r.ClassOrServiceName,
                    ProgramCategory = r.ProgramCategory.ProgramCategory1
                }).ToList();

            return lsKeyValuePairs;
        }

        //save the mutiple request
        public async Task<int> SaveProgramRequestDetails(ProgramRequestInputVm values)
        {
            List<ProgramRequest> programRequestadd = values.ListProgramEligibility
                //.Where(w => w.IsChecked)
                .Select(s => new ProgramRequest
                {
                    CreateBy = _personnelId,
                    CreateDate = DateTime.Now,
                    InmateId = values.InmateId,
                    PriorityLevel = values.Priority,
                    RequestNote = values.Notes,
                    DeleteFlag = 0,
                    ProgramClassId = s.ProgramId // This program table need to change based on programClass
                }).ToList();

            _context.ProgramRequest.AddRange(programRequestadd);

            return await _context.SaveChangesAsync();
        }

        // check the validation for save request
        public int ProgramRequestValid(int programId, int inmateId)
        {
 // This program table need to change based on programClass
            int lProgramRequest = 0;
            lProgramRequest = _context.ProgramRequest.Count(s =>
                s.InmateId == inmateId && s.ProgramClassId == programId && !s.AppointmentProgramAssignId.HasValue
                && s.DeleteFlag == 0 && !s.DeniedFlag.HasValue);
            //request program
            if (lProgramRequest > 0)
            {
                lProgramRequest = programId;
            }
            return lProgramRequest;
        }

        // inmate schedule save & unassign
        public async Task<int> InsertInmateSchedule(ProgramEligibility values)
        {

            int appointmentId = _context.AppointmentProgramAssign
                                    .SingleOrDefault(ap => ap.AppointmentProgramAssignId == values.AppointmentProgramAssignId)
                                    .AppointmentId ?? 0;

            AppointmentProgramAssign appointmentProgramAssign = _context.AppointmentProgramAssign.SingleOrDefault(p =>
                p.AppointmentProgramAssignId == values.AppointmentProgramAssignId &&
                p.AppointmentId == appointmentId);

            appointmentProgramAssign.InmateNote = values.InmateNote;
            appointmentProgramAssign.ProgramPass = values.ProgramPass;
            appointmentProgramAssign.ProgramNotPass = values.ProgramNotPass;
            appointmentProgramAssign.ProgramGrade = values.ProgramGrade;
            appointmentProgramAssign.UpdateDate = DateTime.Now;
            appointmentProgramAssign.UpdateBy = _personnelId;

            string programAttendCertificate = _context.ProgramAttendCertificate.SingleOrDefault(s =>
                s.AppointmentId == appointmentId &&
                s.InmateId == values.InmateId).CertificateName;

            if (values.IsCheckCertificate)
            {
                if (string.IsNullOrEmpty(programAttendCertificate))
                {
                    ProgramAttendCertificate programAttendCertificate1 = new ProgramAttendCertificate
                    {
                        AppointmentId = appointmentId,
                        InmateId = values.InmateId,
                        CertificateName = values.CertificateName,
                        CreateDate = DateTime.Now,
                        CreateBy = _personnelId
                    };
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(programAttendCertificate))
                {
                    ProgramAttendCertificate programAttendCertificate2 = _context.ProgramAttendCertificate.SingleOrDefault(s =>
                        s.AppointmentId == appointmentId &&
                        s.InmateId == values.InmateId);

                    programAttendCertificate2.DeleteFlag = 1;
                    programAttendCertificate2.DeleteBy = _personnelId;
                    programAttendCertificate2.DeleteDate = DateTime.Now;

                }
            }

            return await _context.SaveChangesAsync();
        }


        // Denide or route to classify 
        public async Task<int> SaveDenyandSentProgramRequest(ProgramCatogoryVm Inputs)
        {
            if (Inputs.RequestIds.Count > 0)
            {
                Inputs.RequestIds.ForEach(reqId =>
                {
                    ProgramRequest programRequestDetails = _context.ProgramRequest.SingleOrDefault(p =>
                                p.ProgramRequestId == reqId);
                    if (programRequestDetails != null)
                    {
                        programRequestDetails.DeniedFlag = Inputs.DeniedFlag ? 1 : 0;
                        programRequestDetails.DeniedBy = _personnelId;
                        if (Inputs.DeniedFlag)
                        {
                            programRequestDetails.DeniedDate = DateTime.Now;
                            programRequestDetails.DeniedNote = Inputs.DeniedNote;
                        }
                        programRequestDetails.ClassifyRouteFlag = Inputs.ClassifyRouteFlag ? 1 : 0;
                        programRequestDetails.ClassifyRouteBy = _personnelId;
                        programRequestDetails.ClassifyRouteDate = DateTime.Now;
                        programRequestDetails.ClassifyRouteNote = Inputs.SentNote;
                        programRequestDetails.DeniedReason = Inputs.DenyReason;
                        programRequestDetails.ClassifyRouteReason = Inputs.SentReason;
                    }

                    if (Inputs.IsAppeal)
                    {
                        ProgramRequestAppeal appealDetails = _context.ProgramRequestAppeal
                        .LastOrDefault(p => p.ProgramRequestId == reqId);
                        if (appealDetails != null)
                        {
                            appealDetails.DeniedFlag = Inputs.DeniedFlag ? 1 : 0;
                            appealDetails.DeniedBy = _personnelId;
                            appealDetails.DeniedDate = DateTime.Now;
                            appealDetails.DeniedNote = Inputs.DeniedNote;
                            appealDetails.ClassifyRouteFlag = Inputs.ClassifyRouteFlag ? 1 : 0;
                            appealDetails.ClassifyRouteBy = _personnelId;
                            appealDetails.ClassifyRouteDate = DateTime.Now;
                            appealDetails.ClassifyRouteNote = Inputs.SentNote;
                            appealDetails.SendNoteToHousing = Inputs.SentToHousing;
                        }
                    }

                });
            }
            return await _context.SaveChangesAsync();
        }

        public async Task<int> DeleteProgramRequest(ProgramEligibility ProgramRequest)
        {

            ProgramRequest programRequestDetails = _context.ProgramRequest.SingleOrDefault(p =>
                        p.ProgramRequestId == ProgramRequest.RequestId);
            if (programRequestDetails != null)
            {
                programRequestDetails.DeleteFlag = ProgramRequest.DeleteFlag ? 0 : 1;
                programRequestDetails.UpdateBy = _personnelId;
                programRequestDetails.UpdateDate = DateTime.Now;
            }

            return await _context.SaveChangesAsync();
        }


        public async Task<int> SaveAssignRequest(List<ProgramEligibility> Inputs)
        {
            Inputs.ForEach(req =>
            {
                List<AppointmentProgramAssign> appointmentProgramAssigns = req
                .ScheduleDetails.Select(a => new AppointmentProgramAssign
                {
                    CreateBy = _personnelId,
                    AppointmentId = a.ScheduleId,
                    CreateDate = DateTime.Now,
                    DeleteFlag = 0,
                    InmateId = req.InmateId,
                    InmateNote = req.InmateNote,
                    UpdateDate = DateTime.Now
                }).ToList();
                _context.AppointmentProgramAssign.AddRange(appointmentProgramAssigns);
                _context.SaveChangesAsync();
                ProgramRequest programRequestDetails = _context.ProgramRequest.Single(p =>
                        p.ProgramRequestId == req.RequestId);
                programRequestDetails.AppointmentProgramAssignId = appointmentProgramAssigns.First()
                .AppointmentProgramAssignId;
                programRequestDetails.AssignedBy = _personnelId;
                programRequestDetails.AssignedDate = DateTime.Now;
                programRequestDetails.AssignedNote = req.InmateNote;
                programRequestDetails.UpdateBy = _personnelId;
                programRequestDetails.UpdateDate = DateTime.Now;
                programRequestDetails.DeniedFlag = 0;
                programRequestDetails.ClassifyRouteFlag = 0;
            });
            return await _context.SaveChangesAsync();
        }

        #region Appeal

        //Get All Appeal Details
        public List<ProgramEligibility> GetProgramRequestAppeal(int facilityId)
        {
            List<ProgramEligibility> lstPrgReqApplea = new List<ProgramEligibility>();

            lstPrgReqApplea = _context.ProgramRequestAppeal.Where(pr =>
            pr.ProgramRequestAppealNavigation.Inmate.InmateActive == 1 
            //&& (facilityId == 0
            //|| pr.ProgramRequestAppealNavigation.Program.ProgramCategory.FacilityId == facilityId
            //|| pr.ProgramRequestAppealNavigation.Program.ProgramCategory.FacilityId == 0)
            )
            .Select(p => new ProgramEligibility
            {
                RequestId = p.ProgramRequestId,
                ProgramId = p.ProgramRequestAppealNavigation.ProgramClassId,
                InmateId = p.ProgramRequestAppealNavigation.InmateId,
                RequestDate = p.CreateDate,
                DeleteFlag = p.DeleteFlag == 1,
                ClassifyRouteFlag = p.ClassifyRouteFlag == 1,
                DeniedFlag = p.DeniedFlag == 1,
                AppealFlag = p.AppealFlag == 1,
                SendNoteToHousing = p.SendNoteToHousing,
                //ProgramCategory = p.ProgramRequestAppealNavigation.Program.ProgramCategory.ProgramCategory1,
                //ClassOrServiceName = p.ProgramRequestAppealNavigation.Program.ClassOrServiceName,
                DeniedDetails = new QueueEligibilityPerson
                {
                    PersonnelId = p.DeniedBy,
                    Reason = p.DeniedReason,
                    Note = p.DeniedNote,
                    Date = p.DeniedDate
                },
                AppealDetails = new QueueEligibilityPerson
                {
                    PersonnelId = p.AppealBy,
                    Reason = p.AppealReason,
                    Note = p.AppealNote,
                    Date = p.AppealDate
                },
            }).ToList();
            //Person Details List
            List<PersonVm> lstPersonDetails =
                _inmateService.GetInmateDetails(lstPrgReqApplea.Select(i => i.InmateId).ToList());
            //List of Housing Details for inmates 
            List<HousingDetail> lstHousingDetail = _facilityHousingService.GetHousingList(lstPersonDetails
                .Where(i => i.HousingUnitId.HasValue).Select(i => i.HousingUnitId.Value).ToList());
            //List of all Officer Ids
            List<int> personnelId = lstPrgReqApplea.Select(i => new[] {i.AppealDetails.PersonnelId
                })
                .SelectMany(i => i).Where(i => i.HasValue).Select(i => i.Value).ToList();
            //List of Officer Details
            List<PersonnelVm> lstPersonDet = _personService.GetPersonNameList(personnelId);
            lstPrgReqApplea.ForEach(item =>
            {
                item.InmateDetails = lstPersonDetails.Single(inm => inm.InmateId == item.InmateId);
                if (item.InmateDetails.HousingUnitId.HasValue)
                {
                    item.HousingDetails =
                        lstHousingDetail.Single(inm => inm.HousingUnitId == item.InmateDetails.HousingUnitId.Value);
                }
                if (item.AppealDetails.PersonnelId.HasValue)
                {
                    PersonnelVm personInfo =
                        lstPersonDet.Single(p => p.PersonnelId == item.AppealDetails.PersonnelId);
                    item.AppealDetails.PersonLastName = personInfo?.PersonLastName;
                    item.AppealDetails.OfficerBadgeNumber = personInfo?.OfficerBadgeNumber;
                }
            });
            return lstPrgReqApplea;
        }
        //Save
        public async Task<int> SaveAppealProgramRequest(ProgramCatogoryVm Inputs)
        {
            Inputs.RequestIds.ForEach(reqId =>
            {
                ProgramRequestAppeal appeal = new ProgramRequestAppeal
                {
                    AppealBy = _personnelId,
                    AppealDate = DateTime.Today,
                    CreateDate = DateTime.Today,
                    CreateBy = _personnelId,
                    AppealFlag = 1,
                    AppealReason = Inputs.AppealReason,
                    AppealNote = Inputs.AppealNote,
                    ProgramRequestId = reqId,
                    DeniedDate = Inputs.DeniedDate
                };
                _context.ProgramRequestAppeal.Add(appeal);
            });
            return await _context.SaveChangesAsync();
        }

        public async Task<int> DeleteDenied(int Inputs, bool DeleteFlag)
        {
            if (Inputs > 0)
            {
                ProgramRequest programRequestDetails = _context.ProgramRequest.SingleOrDefault(p =>
                           p.ProgramRequestId == Inputs);
                if (programRequestDetails != null)
                {
                    programRequestDetails.DeleteFlag = DeleteFlag ? 1 : 0;
                    programRequestDetails.UpdateBy = _personnelId;
                    programRequestDetails.UpdateDate = DateTime.Now;
                }
                List<ProgramRequestAppeal> appeal = _context.ProgramRequestAppeal.Where(p =>
                               p.ProgramRequestId == Inputs).ToList();
                if (appeal != null)
                {
                    appeal.ForEach(f =>
                    {
                        f.DeleteFlag = DeleteFlag ? 1 : 0;
                        f.DeleteBy = _personnelId;
                        f.DeleteDate = DateTime.Now;
                    });
                }
            }
            return await _context.SaveChangesAsync();
        }

        public async Task<int> SaveAppealAssignRequest(ProgramEligibility Inputs)
        {
            List<AppointmentProgramAssign> appointmentProgramAssigns = Inputs
                .ScheduleDetails.Select(a => new AppointmentProgramAssign
                {
                    CreateBy = _personnelId,
                    AppointmentId = a.ScheduleId,
                    CreateDate = DateTime.Now,
                    DeleteFlag = 0,
                    InmateId = Inputs.InmateId,
                    InmateNote = Inputs.InmateNote,
                    UpdateDate = DateTime.Now
                }).ToList();
            _context.AppointmentProgramAssign.AddRange(appointmentProgramAssigns);
            await _context.SaveChangesAsync();

            ProgramRequest programRequestDetails = _context.ProgramRequest.Single(p =>
                    p.ProgramRequestId == Inputs.RequestId);
            programRequestDetails.AppointmentProgramAssignId = appointmentProgramAssigns.First()
            .AppointmentProgramAssignId;
            programRequestDetails.AssignedBy = _personnelId;
            programRequestDetails.AssignedDate = DateTime.Now;
            programRequestDetails.AssignedNote = Inputs.InmateNote;
            programRequestDetails.UpdateBy = _personnelId;
            programRequestDetails.UpdateDate = DateTime.Now;
            programRequestDetails.DeniedFlag = 0;
            programRequestDetails.ClassifyRouteFlag = 0;

            ProgramRequestAppeal appealAssignDetails = _context.ProgramRequestAppeal.LastOrDefault(p =>
                   p.ProgramRequestId == Inputs.RequestId);
            appealAssignDetails.AppointmentProgramAssignId = appointmentProgramAssigns.First()
            .AppointmentProgramAssignId;
            appealAssignDetails.AssignedBy = _personnelId;
            appealAssignDetails.AssignedDate = DateTime.Now;
            appealAssignDetails.AssignedNote = Inputs.InmateNote;
            appealAssignDetails.UpdateBy = _personnelId;
            appealAssignDetails.UpdateDate = DateTime.Now;
            appealAssignDetails.DeniedFlag = 0;
            appealAssignDetails.ClassifyRouteFlag = 0;
            return await _context.SaveChangesAsync();
        }

        // load the program appointment for program request
        public List<ProgramEligibility> ListAppointment(int facilityId, int inmateId, int assignId)
        {
            var datalist = _appointmentService.ListAoAppointments(1, 0, System.DateTime.Now,
                System.DateTime.Now.AddMonths(1), true, false, false);
            var fromDate = System.DateTime.Now;
            var toDate = System.DateTime.Now.AddMonths(1);

            List<ProgramEligibility> listProgramEligibilities = new List<ProgramEligibility>();

            List<ScheduleVm> schList = _context.ScheduleInmate.Where(a =>
                    !a.DeleteFlag && (inmateId == 0 || a.InmateId == inmateId))
                .Select(sch => new ScheduleVm
                {
                    StartDate = sch.StartDate,
                    EndDate = sch.EndDate,
                    LocationId = sch.LocationId ?? 0,
                    ScheduleId = sch.ScheduleId,
                    InmateId = sch.InmateId ?? 0,
                    Duration = sch.Duration,
                    IsSingleOccurrence = sch.IsSingleOccurrence,
                    LocationDetail = sch.LocationDetail,
                    DayInterval = sch.DayInterval,
                    WeekInterval = sch.WeekInterval,
                    FrequencyType = sch.FrequencyType,
                    QuarterInterval = sch.QuarterInterval,
                    MonthOfQuarterInterval = sch.MonthOfQuarterInterval,
                    MonthOfYear = sch.MonthOfYear,
                    DayOfMonth = sch.DayOfMonth
                }).ToList();

            List<int> lstSchInmateIds = schList.Select(s => s.InmateId ?? 0).ToList();

            IQueryable<AppointmentProgramAssign> lstAppointmentProgramAssigns = _context.AppointmentProgramAssign
                .Where(a => lstSchInmateIds.Contains(a.InmateId) && a.AppointmentProgramAssignId == assignId && a.DeleteFlag == 0);

            List<int> lstAppInmateIds = lstAppointmentProgramAssigns.Select(inm => new[]
            {
                inm.InmateId, inm.AppointmentId
            }).SelectMany(i => i).Where(i => i.HasValue).Select(i => i.Value).ToList();

            //attendtotal && not attendtotal
            IQueryable<ProgramAttendInmate> lAttendInmates = _context.ProgramAttendInmate.Where(p =>
                lstAppInmateIds.Contains(p.InmateId) && (p.AttendFlag == 1 || p.NotAttendFlag == 1) &&
                lstAppInmateIds.Contains(p.ProgramAttend.AppointmentId)
                && p.ProgramAttend.CompleteFlag == 1);

            List<ProgramEligibilityClassVm> lsPrograms = _context.ProgramRequest.Where(s => lstAppInmateIds.Contains(s.InmateId))
                .Select(r => new ProgramEligibilityClassVm
                {
                    ProgramId = r.ProgramClassId,
                    InmateId = r.InmateId,
                    //ClassOrServiceNumber = r.Program.ClassOrServiceNumber,
                    //ClassOrServiceName = r.Program.ClassOrServiceName,
                    //ProgramCategory = r.Program.ProgramCategory.ProgramCategory1
                }).ToList();

            listProgramEligibilities = _context.AppointmentProgramAssign
                .Where(s => s.InmateId == inmateId && s.DeleteFlag == 0)
                .Select(sch => new ProgramEligibility
                {
                    CreateDate = sch.CreateDate, // Assign
                    DeleteDate = sch.DeleteDate, // Unassign
                    ProgramComplete = sch.ProgramComplete,
                    ProgramNotComplete = sch.ProgramNotComplete,
                    ProgramUnassignReason = sch.ProgramUnassignReason,
                    AttendCount = lAttendInmates.Count(s => s.AttendFlag == 1), // attend cnt
                    NotAttendCount = lAttendInmates.Count(s => s.NotAttendFlag == 1), // not attend cnt
                    ProgramGrade = sch.ProgramGrade,
                    ProgramPass = sch.ProgramPass, // its split into client side
                    ProgramNotPass = sch.ProgramNotPass, // its split into client side
                    Createby = sch.CreateBy,
                    Deleteby = sch.DeleteBy,
                    ProgramUnassignNote = sch.ProgramUnassignNote
                }).ToList();

            listProgramEligibilities.ForEach(item =>
            {
                item.SchedulesDetails.AddRange(schList.Where(i => i.InmateId == item.InmateId));
                item.ProgramEligibilityClass.AddRange(lsPrograms.Where(i => i.InmateId == item.InmateId));
            });

            return listProgramEligibilities;

        }

        #endregion
    }
}
